<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="CockroachDB is an OLTP database, specialized for serving high-throughput queries that read or write a small number of rows. As we gained more usage, we found that customers weren’t getting the performance they expected from analytic queries that read a lot of rows, like large scans, joins, or aggregations. In April 2018, we started to seriously investigate how to improve the performance of these types of queries in CockroachDB, and began working on a new SQL execution engine. In this blog post, we use example code to discuss how we built the new engine and why it results in up to a 4x speed improvement on an industry-standard benchmark.
"><meta name=keywords content=",databases,vectorized-execution,performance,cockroachdb,sql"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=http://asubiotto.com/writing/how-we-built-vectorized-execution-engine/><title>How We Built a Vectorized Execution Engine :: Alfonso Subiotto</title><link rel=stylesheet href=/main.min.07ea7ac7da67e2e153a7dfa2457bc6a19cca824288d175e223fadc579041bc51.css integrity="sha256-B+p6x9pn4uFTp9+iRXvGoZzKgkKI0XXiI/rcV5BBvFE=" crossorigin=anonymous><link rel=stylesheet type=text/css href=/css/custom.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="How We Built a Vectorized Execution Engine"><meta itemprop=description content="CockroachDB is an OLTP database, specialized for serving high-throughput queries that read or write a small number of rows. As we gained more usage, we found that customers weren’t getting the performance they expected from analytic queries that read a lot of rows, like large scans, joins, or aggregations. In April 2018, we started to seriously investigate how to improve the performance of these types of queries in CockroachDB, and began working on a new SQL execution engine. In this blog post, we use example code to discuss how we built the new engine and why it results in up to a 4x speed improvement on an industry-standard benchmark."><meta itemprop=datePublished content="2019-10-31T00:00:00+00:00"><meta itemprop=dateModified content="2019-10-31T00:00:00+00:00"><meta itemprop=wordCount content="3860"><meta itemprop=keywords content="Databases,Vectorized-Execution,Performance,Cockroachdb,Sql"><meta name=twitter:card content="summary"><meta name=twitter:title content="How We Built a Vectorized Execution Engine"><meta name=twitter:description content="CockroachDB is an OLTP database, specialized for serving high-throughput queries that read or write a small number of rows. As we gained more usage, we found that customers weren’t getting the performance they expected from analytic queries that read a lot of rows, like large scans, joins, or aggregations. In April 2018, we started to seriously investigate how to improve the performance of these types of queries in CockroachDB, and began working on a new SQL execution engine. In this blog post, we use example code to discuss how we built the new engine and why it results in up to a 4x speed improvement on an industry-standard benchmark."><meta property="article:published_time" content="2019-10-31 00:00:00 +0000 UTC"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4J888DE1QK"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4J888DE1QK")}</script></head><body><div class=container><header class=header><span class=header__inner><div class=logo></div><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/>Home</a></li><li><a href=/writing/>Writing</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><article><h1 class=post-title>How We Built a Vectorized Execution Engine</h1><div class=post-meta><time datetime=2019-10-31T00:00:00Z>October 31, 2019
</time><span class=post-original>Originally published at <a href=https://www.cockroachlabs.com/blog/how-we-built-a-vectorized-execution-engine/ target=_blank rel=noopener>Cockroach Labs</a></span></div><div class=post-content><p>CockroachDB is an <a href=https://en.wikipedia.org/wiki/Online_transaction_processing>OLTP</a> database, specialized for serving high-throughput queries that read or write a small number of rows. As we gained more usage, we found that customers weren’t getting the performance they expected from analytic queries that read a lot of rows, like large scans, joins, or aggregations. In April 2018, we started to seriously investigate how to improve the performance of these types of queries in CockroachDB, and began working on a new SQL execution engine. In this blog post, we use example code to discuss how we built the new engine and why it results in up to a 4x speed improvement on an industry-standard benchmark.</p><p>OLTP databases, including CockroachDB, store data in contiguous rows on disk and process queries a row of data at a time. This pattern is optimal for serving small queries with high throughput and low latency, since the data in the rows are stored contiguously, making it more efficient to access multiple columns from the same row. Modern <a href=https://en.wikipedia.org/wiki/Online_analytical_processing>OLAP</a> databases, on the other hand, typically are better at serving large queries, and tend to store data in contiguous columns and operate on these columns using a concept called <a href=https://www.infoq.com/articles/columnar-databases-and-vectorization/>vectorized execution</a>. Using vectorized processing in an execution engine makes more efficient use of modern CPUs by changing the data orientation (from rows to columns) to get more out of the CPU cache and deep instruction pipelines by operating on batches of data at a time.</p><p>In our research into vectorized execution, we came across <a href=http://cidrdb.org/cidr2005/papers/P19.pdf>MonetDB/X100: Hyper-Pipelining Query Execution</a>, a paper that outlines the performance deficiencies of the row-at-a-time <a href=https://paperhub.s3.amazonaws.com/dace52a42c07f7f8348b08dc2b186061.pdf>Volcano execution model</a> that CockroachDB’s original execution engine was built on. When executing queries on a large number of rows, the row-oriented execution engine pays a high cost in interpretation and evaluation overhead per tuple and doesn’t take full advantage of the efficiencies of modern CPUs. Given the <a href=https://www.cockroachlabs.com/docs/stable/architecture/storage-layer>key-value storage architecture</a> of CockroachDB, we knew we couldn’t store data in columnar format, but we wondered if converting rows to batches of columnar data after reading them from disk, and then feeding those batches into a vectorized execution engine, would improve performance enough to justify building and maintaining a new execution engine.</p><p>To quantify the performance improvements, and to test the ideas laid out in the paper, we built a <a href=https://github.com/jordanlewis/exectoy>vectorized execution engine prototype</a>, which yielded some impressive results. In this tutorial-style blog post, we take a closer look at what these performance improvements look like in practice. We also demonstrate why and how we use code generation to ease the maintenance burden of the vectorized execution engine. We take an example query, analyze its performance in a toy, row-at-a-time execution engine, and then explore and implement improvements inspired by the ideas proposed in the MonetDB/x100 paper. The code referenced in this post resides in <a href=https://github.com/asubiotto/vecdeepdive>https://github.com/asubiotto/vecdeepdive</a>, so feel free to look at, modify, and/or run the code and benchmarks while you follow along.</p><h2 id=whats-in-a-sql-operator>What’s in a SQL operator?</h2><p>To provide some context, let’s look at how CockroachDB executes a simple query, <code>SELECT price * 0.8 FROM inventory</code>, issued by a fictional retail customer that wants to compute a discounted price for each item in her inventory. Regardless of which execution engine is used, this query is parsed, converted into an <a href=https://en.wikipedia.org/wiki/Abstract_syntax_tree>abstract syntax tree (AST)</a>, optimized, and then executed. The execution, whether distributed amongst all nodes in a cluster, or executed locally, can be thought of as a chain of data manipulations that each have a specific role, which we call operators. In this example query, the execution flow would look like this:
!<a href=https://images.ctfassets.net/00voh0j35590/7Hr3m7BLhDQ3GQbLBhmDo5/5e198602b1762d13ae3064bafb82ee77/executionflow.jpg>executionflow</a>
You can generate a diagram of the physical plan by executing <a href=https://www.cockroachlabs.com/docs/stable/explain#distsql-option><code>EXPLAIN (DISTSQL)</code></a>on the query. As you can see, the execution flow for this query is relatively simple. The <code>TableReader</code> operator reads rows from the <code>inventory</code> table and then executes a post-processing render expression, in this case the multiplication by a constant float. Let’s focus on the render expression, since it’s the part of the flow that is doing the most work.</p><p>Here&rsquo;s the code that executes this render expression in the original, row-oriented execution engine used in CockroachDB (some code is omitted here for simplicity):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>expr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BinaryExpr</span>) <span style=color:#a6e22e>Eval</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EvalContext</span>) (<span style=color:#a6e22e>Datum</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>expr</span>.<span style=color:#a6e22e>Left</span>.(<span style=color:#a6e22e>TypedExpr</span>).<span style=color:#a6e22e>Eval</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>right</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>expr</span>.<span style=color:#a6e22e>Right</span>.(<span style=color:#a6e22e>TypedExpr</span>).<span style=color:#a6e22e>Eval</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>expr</span>.<span style=color:#a6e22e>fn</span>.<span style=color:#a6e22e>Fn</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>right</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The left and right side of the binary expression (<code>BinaryExpr</code>) are both values wrapped in a <code>Datum</code> interface. The <code>BinaryExpr</code> calls <code>expr.fn.Fn</code> with both of these as arguments. In our example, the <code>inventory</code> table has a <code>FLOAT</code> price column, so the <code>Fn</code>is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>Fn</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>_</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EvalContext</span>, <span style=color:#a6e22e>left</span> <span style=color:#a6e22e>Datum</span>, <span style=color:#a6e22e>right</span> <span style=color:#a6e22e>Datum</span>) (<span style=color:#a6e22e>Datum</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewDFloat</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>left</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>DFloat</span>) <span style=color:#f92672>*</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>right</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>DFloat</span>)), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In order to perform the multiplication, the <code>Datum</code> values need to be converted to the expected type. If, instead, we created a <code>price</code> column of type <code>DECIMAL</code>, we would cast <code>0.8</code> to a <code>DECIMAL</code> and then construct a <code>BinaryExpr</code> with a different <code>Fn</code> specialized for multiplying <code>DECIMAL</code>s.</p><p>We now have specialized code for multiplying each type, but the <code>TableReader</code> doesn’t need to worry about it. Before executing the query, the database creates a query plan that specifies the correct <code>Fn</code> for the type that we are working with. This simplifies the code, since we only need to write specialized code as an implementation of an interface. It also makes the code less efficient, as each time we multiply two values together, we need to dynamically resolve which <code>Fn</code> to call, cast the interface values to concrete type values that we can work with, and then convert the result back to an interface value.</p><h2 id=benchmarking-a-simple-operator>Benchmarking a simple operator</h2><p>How expensive is this casting, really? To find the answer to this question, let’s take a similar but simpler toy example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Datum</span> <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Int implements the Datum interface.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Int</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>mulIntDatums</span>(<span style=color:#a6e22e>a</span> <span style=color:#a6e22e>Datum</span>, <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>Datum</span>) <span style=color:#a6e22e>Datum</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>aInt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.(<span style=color:#a6e22e>Int</span>).<span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>bInt</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.(<span style=color:#a6e22e>Int</span>).<span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Int</span>{<span style=color:#66d9ef>int64</span>: <span style=color:#a6e22e>aInt</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>bInt</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>m</span> <span style=color:#a6e22e>mulOperator</span>) <span style=color:#a6e22e>next</span>() []<span style=color:#a6e22e>Datum</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>row</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>input</span>.<span style=color:#a6e22e>next</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>row</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>c</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>columnsToMultiply</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>row</span>[<span style=color:#a6e22e>c</span>] = <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>row</span>[<span style=color:#a6e22e>c</span>], <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>arg</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>row</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is a type-agnostic single operator that can handle multiplication of an arbitrary number of columns by a constant argument. Think of the <code>input</code> as returning the rows from the table. To add support for <code>DECIMAL</code>s, we can simply add another function that multiplies <code>DECIMAL</code>s with a <code>mulFn</code> signature.</p><p>We can measure the performance of this code by writing a benchmark (<a href=https://github.com/asubiotto/vecdeepdive/blob/90db3ceba8a048743d23991b4db234f070dcec57/benchmark_test.go>see it in our repo</a>). This will give us an idea of how fast we can multiply a large number of <code>Int</code> rows by a constant argument. The <a href=https://godoc.org/golang.org/x/perf/benchstat>benchstat</a> tool tells us that it takes around 760 microseconds to do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>test</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>bench</span> <span style=color:#960050;background-color:#1e0010>“</span><span style=color:#a6e22e>BenchmarkRowBasedInterface</span><span style=color:#960050;background-color:#1e0010>$”</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>count</span> <span style=color:#ae81ff>10</span> &gt; <span style=color:#a6e22e>tmp</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>benchstat</span> <span style=color:#a6e22e>tmp</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>tmp</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span>               	<span style=color:#a6e22e>time</span><span style=color:#f92672>/</span><span style=color:#a6e22e>op</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RowBasedInterface</span><span style=color:#f92672>-</span><span style=color:#ae81ff>12</span>	<span style=color:#ae81ff>760</span><span style=color:#a6e22e>µs</span> <span style=color:#960050;background-color:#1e0010>±</span><span style=color:#ae81ff>15</span><span style=color:#f92672>%</span>
</span></span></code></pre></div><p>Because we have nothing to compare the performance against at this point, we don’t know if this is slow or not.</p><p>We’ll use a “speed of light” benchmark to get a better relative sense of this program’s speed. A “speed of light” benchmark measures the performance of the minimum necessary work to perform an operation. In this case, what we really are doing is multiplying 65,536 <code>int64</code>s by</p><ol start=2><li>The result of running <a href=https://github.com/asubiotto/vecdeepdive/blob/90db3ceba8a048743d23991b4db234f070dcec57/benchmark_test.go>this benchmark</a> is:</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>test</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>bench</span> <span style=color:#e6db74>&#34;SpeedOfLight&#34;</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>count</span> <span style=color:#ae81ff>10</span> &gt; <span style=color:#a6e22e>tmp</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>benchstat</span> <span style=color:#a6e22e>tmp</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rm</span> <span style=color:#a6e22e>tmp</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>name</span>               	<span style=color:#a6e22e>time</span><span style=color:#f92672>/</span><span style=color:#a6e22e>op</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SpeedOfLight</span><span style=color:#f92672>-</span><span style=color:#ae81ff>12</span>    	<span style=color:#ae81ff>19.0</span><span style=color:#a6e22e>µs</span> <span style=color:#960050;background-color:#1e0010>±</span> <span style=color:#ae81ff>6</span><span style=color:#f92672>%</span>
</span></span></code></pre></div><p>This simple implementation is about 40x faster than our earlier operator!</p><p>To try to figure out what’s going on, let’s run a CPU profile on <code>BenchmarkRowBasedInterface</code> and focus on the <code>mulOperator</code>. We can use the <code>-o</code> option to obtain an executable, which will let us disassemble the function with the <code>disasm</code> command in <a href=https://github.com/google/pprof/>pprof</a>. As we will see below, this command will give us the assembly that our Go source code compiles into, along with approximate CPU times for each instruction. First, let’s use the <code>top</code> and <code>list</code> commands to find the slow parts of the code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>test</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>bench</span> <span style=color:#e6db74>&#34;BenchmarkRowBasedInterface$&#34;</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>cpuprofile</span> <span style=color:#a6e22e>cpu</span>.<span style=color:#a6e22e>out</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>o</span> <span style=color:#a6e22e>row_based_interface</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>…</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>tool</span> <span style=color:#a6e22e>pprof</span> .<span style=color:#f92672>/</span><span style=color:#a6e22e>row_based_interface</span> <span style=color:#a6e22e>cpu</span>.<span style=color:#a6e22e>out</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>pprof</span>) <span style=color:#a6e22e>focus</span>=<span style=color:#a6e22e>mulOperator</span>
</span></span><span style=display:flex><span>(<span style=color:#a6e22e>pprof</span>) <span style=color:#a6e22e>top</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Active</span> <span style=color:#a6e22e>filters</span>:
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>focus</span>=<span style=color:#a6e22e>mulOperator</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Showing</span> <span style=color:#a6e22e>nodes</span> <span style=color:#a6e22e>accounting</span> <span style=color:#66d9ef>for</span> <span style=color:#ae81ff>1.99</span><span style=color:#a6e22e>s</span>, <span style=color:#ae81ff>88.05</span><span style=color:#f92672>%</span> <span style=color:#a6e22e>of</span> <span style=color:#ae81ff>2.26</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>total</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Dropped</span> <span style=color:#ae81ff>15</span> <span style=color:#a6e22e>nodes</span> (<span style=color:#a6e22e>cum</span> <span style=color:#f92672>**</span><span style=color:#a6e22e>D</span><span style=color:#f92672>**</span><span style=color:#a6e22e>on</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#f92672>**</span><span style=color:#a6e22e>R</span><span style=color:#f92672>**</span><span style=color:#a6e22e>epeat</span> <span style=color:#f92672>**</span><span style=color:#a6e22e>Y</span><span style=color:#f92672>**</span><span style=color:#a6e22e>ourself</span>). <span style=color:#a6e22e>The</span> <span style=color:#a6e22e>situation</span> <span style=color:#a6e22e>seems</span> <span style=color:#a6e22e>even</span> <span style=color:#a6e22e>worse</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>consider</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>real</span> <span style=color:#a6e22e>database</span> <span style=color:#a6e22e>engine</span>, <span style=color:#a6e22e>there</span> <span style=color:#a6e22e>would</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>far</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>than</span> <span style=color:#a6e22e>two</span> <span style=color:#a6e22e>types</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>support</span>. <span style=color:#a6e22e>If</span> <span style=color:#a6e22e>someone</span> <span style=color:#a6e22e>were</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>slightly</span> <span style=color:#a6e22e>change</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>multiplication</span> <span style=color:#a6e22e>functionality</span> (<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>example</span>, <span style=color:#a6e22e>adding</span> <span style=color:#a6e22e>overflow</span> <span style=color:#a6e22e>handling</span>), <span style=color:#a6e22e>they</span> <span style=color:#a6e22e>would</span> <span style=color:#a6e22e>have</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>rewrite</span> <span style=color:#a6e22e>every</span> <span style=color:#a6e22e>single</span> <span style=color:#a6e22e>operator</span>, <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>tedious</span> <span style=color:#a6e22e>and</span> <span style=color:#66d9ef>error</span><span style=color:#f92672>-</span><span style=color:#a6e22e>prone</span>. <span style=color:#a6e22e>The</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>types</span>, <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>work</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>do</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>update</span> <span style=color:#a6e22e>code</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#a6e22e>Generating</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>templates</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Thankfully</span>, <span style=color:#a6e22e>there</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>tool</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>reduce</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>burden</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>keep</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>good</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>characteristics</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>working</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>concrete</span> <span style=color:#a6e22e>types</span>. <span style=color:#a6e22e>The</span> [<span style=color:#a6e22e>Go</span> <span style=color:#a6e22e>templating</span> <span style=color:#a6e22e>engine</span>](<span style=color:#a6e22e>https</span>:<span style=color:#75715e>//golang.org/pkg/text/template/) allows us to write a code template that, with a bit of work, we can trick our editor into treating as a regular Go file. We have to use the templating engine because the version of Go we are currently using does not have support for generic types. Templating the multiplication operators would look like this (full template code is in [row_based_typed_tmpl.go](https://github.com/asubiotto/vecdeepdive/blob/90db3ceba8a048743d23991b4db234f070dcec57/row_based_typed_tmpl.go)):</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`// </span><span style=color:#75715e>{{/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>type _GOTYPE interface{}
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>// _MULFN assigns the result of the multiplication of the first and second
</span></span></span><span style=display:flex><span><span style=color:#75715e>// operand to the first operand.
</span></span></span><span style=display:flex><span><span style=color:#75715e>func _MULFN(_ TypedDatum, _ interface{}) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>	panic(&#34;do not call from non-templated code&#34;)
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>// */}}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>// </span><span style=color:#75715e>{{</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>.</span><span style=color:#75715e>}}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>type mul_TYPEOperator struct {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	input             TypedOperator
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	arg               _GOTYPE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	columnsToMultiply []int
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>func (m mul_TYPEOperator) next() []TypedDatum {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	row := m.input.next()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	if row == nil {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		return nil
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	for _, c := range m.columnsToMultiply {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>		_MULFN(row[c], m.arg)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>	return row
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>// </span><span style=color:#75715e>{{</span> <span style=color:#66d9ef>end</span> <span style=color:#75715e>}}</span><span style=color:#e6db74>`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>accompanying</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>generate</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>full</span> <span style=color:#e6db74>`row_based_typed.gen.go`</span> <span style=color:#a6e22e>file</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>located</span> <span style=color:#a6e22e>in</span> [<span style=color:#e6db74>`row_based_type_gen.go`</span>](<span style=color:#a6e22e>https</span>:<span style=color:#75715e>//github.com/asubiotto/vecdeepdive/blob/90db3ceba8a048743d23991b4db234f070dcec57/row_based_typed_gen.go)). This code is executed by running `go run .` to run the `main()` function in `generate.go` (omitted here for conciseness). The generator will iterate over a slice and fill the template in with specific information for each type. Note that there is a prior step that is necessary in order to consider the `row_based_typed_tmpl.go` file valid Go. In the template, we use tokens that are valid Go (e.g. _GOTYPE and _MULFN). These tokens’ declarations are wrapped in template comments and removed in the final generated file.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>For</span> <span style=color:#a6e22e>example</span>, <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>multiplication</span> <span style=color:#a6e22e>function</span> (<span style=color:#e6db74>`_MULFN`</span>) <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>converted</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>method</span> <span style=color:#a6e22e>call</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>same</span> <span style=color:#a6e22e>arguments</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`// Replace all functions.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mulFnRe := regexp.MustCompile(`</span><span style=color:#a6e22e>_MULFN</span><span style=color:#960050;background-color:#1e0010>\</span>((.<span style=color:#f92672>*</span>),(.<span style=color:#f92672>*</span>)<span style=color:#960050;background-color:#1e0010>\</span>)<span style=color:#e6db74>`)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>s = mulFnRe.ReplaceAllString(s, `</span>{{ .<span style=color:#a6e22e>MulFn</span> <span style=color:#e6db74>&#34;$1&#34;</span> <span style=color:#e6db74>&#34;$2&#34;</span> }}<span style=color:#e6db74>`)`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e6db74>`MulFn`</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>called</span> <span style=color:#a6e22e>when</span> <span style=color:#a6e22e>executing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>template</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>then</span> <span style=color:#a6e22e>returns</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>Go</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>perform</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>multiplication</span> <span style=color:#a6e22e>according</span> <span style=color:#a6e22e>to</span> <span style=color:#66d9ef>type</span><span style=color:#f92672>-</span><span style=color:#a6e22e>specific</span> <span style=color:#a6e22e>information</span>. <span style=color:#a6e22e>Take</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>look</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>final</span> <span style=color:#a6e22e>generated</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>in</span> [<span style=color:#a6e22e>row_based_typed</span>.<span style=color:#a6e22e>gen</span>.<span style=color:#66d9ef>go</span>.](<span style=color:#a6e22e>https</span>:<span style=color:#75715e>//github.com/asubiotto/vecdeepdive/blob/90db3ceba8a048743d23991b4db234f070dcec57/row_based_typed.gen.go))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>templating</span> <span style=color:#a6e22e>approach</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>took</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>some</span> <span style=color:#a6e22e>rough</span> <span style=color:#a6e22e>edges</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>certainly</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>very</span> <span style=color:#a6e22e>flexible</span> <span style=color:#a6e22e>implementation</span>. <span style=color:#a6e22e>Nonetheless</span>, <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>critical</span> <span style=color:#a6e22e>part</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>real</span> <span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>execution</span> <span style=color:#a6e22e>engine</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>built</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>CockroachDB</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>was</span> <span style=color:#a6e22e>simple</span> <span style=color:#a6e22e>enough</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>build</span> <span style=color:#a6e22e>without</span> <span style=color:#a6e22e>getting</span> <span style=color:#a6e22e>sidetracked</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>creating</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>robust</span> <span style=color:#a6e22e>domain</span><span style=color:#f92672>-</span><span style=color:#a6e22e>specific</span> <span style=color:#a6e22e>language</span>. <span style=color:#a6e22e>Now</span>, <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>want</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>add</span> <span style=color:#a6e22e>functionality</span> <span style=color:#a6e22e>or</span> <span style=color:#a6e22e>fix</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>bug</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>modify</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>template</span> <span style=color:#a6e22e>once</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>regenerate</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>code</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>changes</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>operators</span>. <span style=color:#a6e22e>Now</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>little</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>manageable</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>extensible</span>, <span style=color:#a6e22e>let</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>try</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>improve</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>further</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>NOTE</span>: <span style=color:#a6e22e>To</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>rest</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>blog</span> <span style=color:#a6e22e>post</span> <span style=color:#a6e22e>easier</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>read</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>won</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>generation</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>following</span> <span style=color:#a6e22e>operator</span> <span style=color:#a6e22e>rewrites</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#a6e22e>Batching</span> <span style=color:#a6e22e>expensive</span> <span style=color:#a6e22e>calls</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Repeating</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>benchmarking</span> <span style=color:#a6e22e>process</span> <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>before</span> <span style=color:#a6e22e>shows</span> <span style=color:#a6e22e>us</span> <span style=color:#a6e22e>some</span> <span style=color:#a6e22e>useful</span> <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>steps</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`$ go test -bench &#34;BenchmarkRowBasedTyped$&#34; -cpuprofile cpu.out -o row_typed_bench
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$ go tool pprof ./row_typed_bench cpu.out
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(pprof) list next
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ROUTINE ======================== _~/scratch/vecdeepdive.mulInt64Operator.next in ~/scratch/vecdeepdive/row_based_typed.gen.go
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	1.26s  	1.92s (flat, cum) 85.71% of Total
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	.  	8:    input         	TypedOperator
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	.  	9:    arg           	int64
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	10:    columnsToMultiply []int
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	11:}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	12:
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	180ms  	180ms 	13:func (m mulInt64Operator) next() []TypedDatum {
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	170ms  	830ms 	14:    row := m.input.next()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	15:    if row == nil {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	16:   	 return nil
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	17:    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	330ms  	330ms 	18:    for _, c := range m.columnsToMultiply {
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	500ms  	500ms 	19:   	 row[c].int64*= m.arg
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	20:    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  	80ms   	80ms 	21:    return row
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	22:}`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>This</span> <span style=color:#a6e22e>part</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>profile</span> <span style=color:#a6e22e>shows</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>approximately</span> <span style=color:#a6e22e>half</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>time</span> <span style=color:#a6e22e>spent</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>the</span> <span style=color:#e6db74>`mulInt64Operator.next`</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>spent</span> <span style=color:#a6e22e>calling</span> <span style=color:#e6db74>`m.input.next()`</span> (<span style=color:#a6e22e>see</span> <span style=color:#a6e22e>line</span> <span style=color:#ae81ff>13</span> <span style=color:#a6e22e>above</span>). <span style=color:#a6e22e>This</span> <span style=color:#a6e22e>isn</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#a6e22e>surprising</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>look</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>implementation</span> <span style=color:#a6e22e>of</span> <span style=color:#e6db74>`(*typedTableReader).next()`</span>; <span style=color:#a6e22e>it</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>lot</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>just</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>advancing</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>element</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>slice</span>. <span style=color:#a6e22e>We</span> <span style=color:#a6e22e>can</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#a6e22e>optimize</span> <span style=color:#a6e22e>too</span> <span style=color:#a6e22e>much</span> <span style=color:#a6e22e>about</span> <span style=color:#a6e22e>the</span> <span style=color:#e6db74>`typedTableReader`</span>, <span style=color:#a6e22e>since</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>need</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>preserve</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>ability</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>chained</span> <span style=color:#a6e22e>to</span> <span style=color:#66d9ef>any</span> <span style=color:#a6e22e>other</span> <span style=color:#a6e22e>SQL</span> <span style=color:#a6e22e>operator</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>may</span> <span style=color:#a6e22e>implement</span>. <span style=color:#a6e22e>But</span> <span style=color:#a6e22e>there</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>another</span> <span style=color:#a6e22e>important</span> <span style=color:#a6e22e>optimization</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>do</span>: <span style=color:#a6e22e>instead</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>calling</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>function</span> <span style=color:#a6e22e>once</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>each</span> <span style=color:#a6e22e>row</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>back</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>batch</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>rows</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>operate</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>them</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>once</span>, <span style=color:#a6e22e>without</span> <span style=color:#a6e22e>changing</span> <span style=color:#a6e22e>too</span> <span style=color:#a6e22e>much</span> <span style=color:#a6e22e>about</span> <span style=color:#e6db74>`(*typedTableReader).next`</span>. <span style=color:#a6e22e>We</span> <span style=color:#a6e22e>can</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#a6e22e>just</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>rows</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>once</span>, <span style=color:#a6e22e>because</span> <span style=color:#a6e22e>some</span> <span style=color:#a6e22e>queries</span> <span style=color:#a6e22e>might</span> <span style=color:#a6e22e>result</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>huge</span> <span style=color:#a6e22e>dataset</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>won</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#a6e22e>fit</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>memory</span>, <span style=color:#a6e22e>but</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>pick</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>reasonably</span> <span style=color:#a6e22e>large</span> <span style=color:#a6e22e>batch</span> <span style=color:#a6e22e>size</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>With</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>optimization</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>have</span> <span style=color:#a6e22e>operators</span> <span style=color:#a6e22e>like</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>ones</span> <span style=color:#a6e22e>below</span>. <span style=color:#a6e22e>Once</span> <span style=color:#a6e22e>again</span>, <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>full</span> <span style=color:#a6e22e>code</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>new</span> <span style=color:#a6e22e>version</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>omitted</span>, <span style=color:#a6e22e>since</span> <span style=color:#a6e22e>there</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>lot</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>boilerplate</span> <span style=color:#a6e22e>changes</span>. <span style=color:#a6e22e>Full</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>examples</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>found</span> <span style=color:#a6e22e>in</span> [<span style=color:#a6e22e>row_based_typed_batch</span>.<span style=color:#66d9ef>go</span>](<span style=color:#a6e22e>https</span>:<span style=color:#75715e>//github.com/asubiotto/vecdeepdive/blob/master/row_based_typed_batch.go).</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`type mulInt64BatchOperator struct {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    input         	TypedBatchOperator
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    arg           	int64
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    columnsToMultiply []int
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>func (m mulInt64BatchOperator) next() [][]TypedDatum {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rows := m.input.next()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if rows == nil {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 return nil
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    for _, row := range rows {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 for _, c := range m.columnsToMultiply {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   		 row[c] = TypedDatum{t: Int64Type, int64: row[c].int64 * m.arg}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return rows
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>type typedBatchTableReader struct {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    curIdx int
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    rows   [][]TypedDatum
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>func (t *typedBatchTableReader) next() [][]TypedDatum {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if t.curIdx &gt;= len(t.rows) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 return nil
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    endIdx := t.curIdx + batchSize
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if endIdx &gt; len(t.rows) {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 endIdx = len(t.rows)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    retRows := t.rows[t.curIdx:endIdx]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    t.curIdx = endIdx
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return retRows
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>With</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>batching</span> <span style=color:#a6e22e>change</span>, <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>benchmarks</span> <span style=color:#a6e22e>run</span> <span style=color:#a6e22e>nearly</span> <span style=color:#ae81ff>3</span><span style=color:#a6e22e>x</span> <span style=color:#a6e22e>faster</span> (<span style=color:#a6e22e>and</span> <span style=color:#ae81ff>5.5</span><span style=color:#a6e22e>x</span> <span style=color:#a6e22e>faster</span> <span style=color:#a6e22e>than</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>original</span> <span style=color:#a6e22e>implementation</span>): 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`$ go test -bench &#34;BenchmarkRowBasedTypedBatch$&#34; -count 10 &gt; tmp &amp;&amp; benchstat tmp &amp;&amp; rm tmp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name               	time/op
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RowBasedTypedBatch-12   137µs ±77%`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#a6e22e>Column</span><span style=color:#f92672>-</span><span style=color:#a6e22e>oriented</span> <span style=color:#a6e22e>Data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>But</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>still</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>long</span> <span style=color:#a6e22e>ways</span> <span style=color:#a6e22e>away</span> <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>getting</span> <span style=color:#a6e22e>close</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>our</span> <span style=color:#960050;background-color:#1e0010>“</span><span style=color:#a6e22e>speed</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>light</span><span style=color:#960050;background-color:#1e0010>”</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>of</span> <span style=color:#ae81ff>19</span> <span style=color:#a6e22e>microseconds</span> <span style=color:#a6e22e>per</span> <span style=color:#a6e22e>operation</span>. <span style=color:#a6e22e>Does</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>new</span> <span style=color:#a6e22e>profile</span> <span style=color:#a6e22e>give</span> <span style=color:#a6e22e>us</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>clues</span><span style=color:#960050;background-color:#1e0010>?</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`$ go test -bench &#34;BenchmarkRowBasedTypedBatch&#34; -cpuprofile cpu.out -o row_typed_batch_bench
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$ go tool pprof ./row_typed_batch_bench cpu.out
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(pprof) list next
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Total: 990ms
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ROUTINE ======================== _~/scratch/vecdeepdive.mulInt64BatchOperator.next in ~/scratch/vecdeepdive/row_based_typed_batch.go
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	950ms  	950ms (flat, cum) 95.96% of Total
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	15:func (m mulInt64BatchOperator) next() [][]TypedDatum {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	16:    rows := m.input.next()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	17:    if rows == nil {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	18:   	 return nil
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	19:    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	210ms  	210ms 	20:    for _, row := range rows {
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	300ms  	300ms 	21:   	 for _, c := range m.columnsToMultiply {
</span></span></span><span style=display:flex><span><span style=color:#e6db74> 	440ms  	440ms 	22:   		 row[c] = TypedDatum{t: Int64Type, int64: row[c].int64 * m.arg}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	23:   	 }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	24:    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	25:    return rows
</span></span></span><span style=display:flex><span><span style=color:#e6db74>     	.      	. 	26:}`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Now</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>time</span> <span style=color:#a6e22e>calling</span> <span style=color:#e6db74>`(*typedBatchTableReader).next`</span> <span style=color:#a6e22e>barely</span> <span style=color:#a6e22e>registers</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>profile</span>! <span style=color:#a6e22e>That</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>much</span> <span style=color:#a6e22e>better</span>. <span style=color:#a6e22e>The</span> <span style=color:#a6e22e>profile</span> <span style=color:#a6e22e>shows</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>lines</span> <span style=color:#ae81ff>20</span><span style=color:#f92672>-</span><span style=color:#ae81ff>22</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>probably</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>best</span> <span style=color:#a6e22e>place</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>focus</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>efforts</span> <span style=color:#a6e22e>next</span>. <span style=color:#a6e22e>These</span> <span style=color:#a6e22e>lines</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>where</span> <span style=color:#a6e22e>well</span> <span style=color:#a6e22e>above</span> <span style=color:#ae81ff>95</span><span style=color:#f92672>%</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>time</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>spent</span>. <span style=color:#a6e22e>That</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>partially</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>good</span> <span style=color:#a6e22e>sign</span>, <span style=color:#a6e22e>because</span> <span style=color:#a6e22e>these</span> <span style=color:#a6e22e>lines</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>implementing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>core</span> <span style=color:#a6e22e>logic</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>operator</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>However</span>, <span style=color:#a6e22e>there</span> <span style=color:#a6e22e>certainly</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>still</span> <span style=color:#a6e22e>room</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>improvement</span>. <span style=color:#a6e22e>Approximately</span> <span style=color:#a6e22e>half</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>time</span> <span style=color:#a6e22e>spent</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>these</span> <span style=color:#a6e22e>three</span> <span style=color:#a6e22e>lines</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>just</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>iterating</span> <span style=color:#a6e22e>through</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>loops</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>loop</span> <span style=color:#a6e22e>body</span> <span style=color:#a6e22e>itself</span>. <span style=color:#a6e22e>If</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>think</span> <span style=color:#a6e22e>about</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>sizes</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>loops</span>, <span style=color:#a6e22e>then</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>starts</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>become</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>clear</span>. <span style=color:#a6e22e>The</span> <span style=color:#a6e22e>length</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>rows</span> <span style=color:#a6e22e>batch</span> <span style=color:#a6e22e>is</span> <span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>024</span>, <span style=color:#a6e22e>but</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>length</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>columnsToMultiply</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>just</span> <span style=color:#ae81ff>1.</span> <span style=color:#a6e22e>Since</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>rows</span> <span style=color:#a6e22e>loop</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>outer</span> <span style=color:#a6e22e>loop</span>, <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>means</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>setting</span> <span style=color:#a6e22e>up</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>tiny</span> <span style=color:#a6e22e>inner</span> <span style=color:#a6e22e>loop</span> <span style=color:#f92672>--</span> <span style=color:#a6e22e>initializing</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>counter</span>, <span style=color:#a6e22e>incrementing</span> <span style=color:#a6e22e>it</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>checking</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>boundary</span> <span style=color:#a6e22e>condition</span> <span style=color:#f92672>--</span> <span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>024</span> <span style=color:#a6e22e>times</span>! <span style=color:#a6e22e>We</span> <span style=color:#a6e22e>could</span> <span style=color:#a6e22e>avoid</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>repeated</span> <span style=color:#a6e22e>work</span> <span style=color:#a6e22e>simply</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>changing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>two</span> <span style=color:#a6e22e>loops</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Although</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>won</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>full</span> <span style=color:#a6e22e>exploration</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>architecture</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>post</span>, <span style=color:#a6e22e>there</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>two</span> <span style=color:#a6e22e>important</span> <span style=color:#a6e22e>concepts</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>come</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>play</span> <span style=color:#a6e22e>when</span> <span style=color:#a6e22e>changing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>loop</span> <span style=color:#a6e22e>order</span>: <span style=color:#a6e22e>branch</span> <span style=color:#a6e22e>prediction</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>pipelining</span>. <span style=color:#a6e22e>In</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>speed</span> <span style=color:#a6e22e>up</span> <span style=color:#a6e22e>execution</span>, <span style=color:#a6e22e>CPUs</span> <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>technique</span> <span style=color:#a6e22e>called</span> <span style=color:#a6e22e>pipelining</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>begin</span> <span style=color:#a6e22e>executing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>instruction</span> <span style=color:#a6e22e>before</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>preceding</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>completed</span>. <span style=color:#a6e22e>This</span> <span style=color:#a6e22e>works</span> <span style=color:#a6e22e>well</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>the</span> <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>sequential</span> <span style=color:#a6e22e>code</span>, <span style=color:#a6e22e>but</span> <span style=color:#a6e22e>whenever</span> <span style=color:#a6e22e>there</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>conditional</span> <span style=color:#a6e22e>branches</span>, <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>cannot</span> <span style=color:#a6e22e>identify</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>certainty</span> <span style=color:#a6e22e>what</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>instruction</span> <span style=color:#a6e22e>after</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>branch</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>be</span>. <span style=color:#a6e22e>However</span>, <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>guess</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>branch</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>followed</span>. <span style=color:#a6e22e>If</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>guesses</span> <span style=color:#a6e22e>incorrectly</span>, <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>work</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>already</span> <span style=color:#a6e22e>performed</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>begin</span> <span style=color:#a6e22e>evaluating</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>next</span> <span style=color:#a6e22e>instruction</span> <span style=color:#a6e22e>will</span> <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>waste</span>. <span style=color:#a6e22e>Modern</span> <span style=color:#a6e22e>CPUs</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>able</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>predictions</span> <span style=color:#a6e22e>based</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>static</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>analysis</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>even</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>results</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>previous</span> <span style=color:#a6e22e>evaluations</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>same</span> <span style=color:#a6e22e>branch</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Changing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>loops</span> <span style=color:#a6e22e>comes</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>another</span> <span style=color:#a6e22e>benefit</span>. <span style=color:#a6e22e>Since</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>outer</span> <span style=color:#a6e22e>loop</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>tell</span> <span style=color:#a6e22e>us</span> <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>column</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>operate</span> <span style=color:#a6e22e>on</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>load</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>data</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>column</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>once</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>store</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>memory</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>contiguous</span> <span style=color:#a6e22e>slice</span>. <span style=color:#a6e22e>A</span> <span style=color:#a6e22e>critical</span> <span style=color:#a6e22e>component</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>modern</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>architecture</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>cache</span> <span style=color:#a6e22e>subsystem</span>. <span style=color:#a6e22e>In</span> <span style=color:#a6e22e>order</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>avoid</span> <span style=color:#a6e22e>loading</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>main</span> <span style=color:#a6e22e>memory</span> <span style=color:#a6e22e>too</span> <span style=color:#a6e22e>often</span>, <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>relatively</span> <span style=color:#a6e22e>slow</span> <span style=color:#a6e22e>operation</span>, <span style=color:#a6e22e>CPUs</span> <span style=color:#a6e22e>have</span> <span style=color:#a6e22e>layers</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>caches</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>provide</span> <span style=color:#a6e22e>fast</span> <span style=color:#a6e22e>access</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>frequently</span> <span style=color:#a6e22e>used</span> <span style=color:#a6e22e>pieces</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>they</span> <span style=color:#a6e22e>can</span> <span style=color:#a6e22e>also</span> <span style=color:#a6e22e>prefetch</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>these</span> <span style=color:#a6e22e>caches</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>access</span> <span style=color:#a6e22e>pattern</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>predictable</span>. <span style=color:#a6e22e>In</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>row</span> <span style=color:#a6e22e>based</span> <span style=color:#a6e22e>example</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>would</span> <span style=color:#a6e22e>load</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>data</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>each</span> <span style=color:#a6e22e>row</span>, <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>would</span> <span style=color:#a6e22e>include</span> <span style=color:#a6e22e>columns</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>were</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>affected</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>operator</span>, <span style=color:#a6e22e>so</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>much</span> <span style=color:#a6e22e>relevant</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>would</span> <span style=color:#a6e22e>fit</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>cache</span>. <span style=color:#a6e22e>Orienting</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>going</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>operate</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>column</span> <span style=color:#a6e22e>provides</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>exactly</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>predictability</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>dense</span> <span style=color:#a6e22e>memory</span><span style=color:#f92672>-</span><span style=color:#a6e22e>packing</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>needs</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>ideal</span> <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>its</span> <span style=color:#a6e22e>caches</span>. 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>For</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>fuller</span> <span style=color:#a6e22e>treatment</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>pipelining</span>, <span style=color:#a6e22e>branch</span> <span style=color:#a6e22e>prediction</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>caches</span> <span style=color:#a6e22e>see</span> <span style=color:#a6e22e>Dan</span> <span style=color:#a6e22e>Luu</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>s</span> [<span style=color:#a6e22e>branch</span> <span style=color:#a6e22e>prediction</span> <span style=color:#a6e22e>talk</span> <span style=color:#a6e22e>notes</span>](<span style=color:#a6e22e>https</span>:<span style=color:#75715e>//danluu.com/branch-prediction/), his [CPU cache blog post](https://danluu.com/3c-conflict/), or [Dave Cheney&#39;s notes from his High Performance Go Workshop](https://dave.cheney.net/high-performance-go-workshop/dotgo-paris.html).</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>below</span> <span style=color:#a6e22e>shows</span> <span style=color:#a6e22e>how</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>could</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>loop</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>orientation</span> <span style=color:#a6e22e>changes</span> <span style=color:#a6e22e>described</span> <span style=color:#a6e22e>above</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>also</span> <span style=color:#a6e22e>define</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>few</span> <span style=color:#a6e22e>new</span> <span style=color:#a6e22e>types</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>same</span> <span style=color:#a6e22e>time</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>easier</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>work</span> <span style=color:#a6e22e>with</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`type vector interface {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    // Type returns the type of data stored in this vector.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Type() T
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    // Int64 returns an int64 slice.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Int64() []int64
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    // Float64 returns a float64 slice.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    Float64() []float64
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>type colBatch struct {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    size int
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    vecs []vector
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>func (m mulInt64ColOperator) next() colBatch {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    batch := m.input.next()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if batch.size == 0 {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 return batch
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    for _, c := range m.columnsToMultiply {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 vec := batch.vecs[c].Int64()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 for i := range vec {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   		 vec[i] = vec[i] * m.arg
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   	 }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return batch
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#a6e22e>reason</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>introduced</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>new</span> <span style=color:#e6db74>`vector`</span> <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>so</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>could</span> <span style=color:#a6e22e>have</span> <span style=color:#a6e22e>one</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>could</span> <span style=color:#a6e22e>represent</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>batch</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>data</span> <span style=color:#a6e22e>of</span> <span style=color:#66d9ef>any</span> <span style=color:#66d9ef>type</span>. <span style=color:#a6e22e>The</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>has</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>slice</span> <span style=color:#a6e22e>field</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>each</span> <span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>but</span> <span style=color:#a6e22e>only</span> <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>these</span> <span style=color:#a6e22e>slices</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>ever</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>non</span><span style=color:#f92672>-</span><span style=color:#66d9ef>nil</span>. <span style=color:#a6e22e>You</span> <span style=color:#a6e22e>may</span> <span style=color:#a6e22e>have</span> <span style=color:#a6e22e>noticed</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>have</span> <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>re</span><span style=color:#f92672>-</span><span style=color:#a6e22e>introduced</span> <span style=color:#a6e22e>some</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>conversion</span>, <span style=color:#a6e22e>but</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>price</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>pay</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>it</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>now</span> <span style=color:#a6e22e>amortized</span> <span style=color:#a6e22e>thanks</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>batching</span>. <span style=color:#a6e22e>Let</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>take</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>look</span> <span style=color:#a6e22e>at</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>benchmark</span> <span style=color:#a6e22e>now</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`$ go test -bench &#34;BenchmarkColBasedTyped&#34; -count 10 &gt; tmp &amp;&amp; benchstat tmp &amp;&amp; rm tmp
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name               	time/op
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ColBasedTyped-12   	38.2µs ±24%`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>This</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>another</span> <span style=color:#a6e22e>nearly</span> ~<span style=color:#ae81ff>3.5</span><span style=color:#a6e22e>x</span> <span style=color:#a6e22e>improvement</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>a</span> ~<span style=color:#ae81ff>20</span><span style=color:#a6e22e>x</span> <span style=color:#a6e22e>improvement</span> <span style=color:#a6e22e>over</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>original</span> <span style=color:#a6e22e>row</span><span style=color:#f92672>-</span><span style=color:#a6e22e>at</span><span style=color:#f92672>-</span><span style=color:#a6e22e>a</span><span style=color:#f92672>-</span><span style=color:#a6e22e>time</span> <span style=color:#a6e22e>version</span>! <span style=color:#a6e22e>Our</span> <span style=color:#a6e22e>speed</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>light</span> <span style=color:#a6e22e>benchmark</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>still</span> <span style=color:#a6e22e>about</span> <span style=color:#ae81ff>2</span><span style=color:#a6e22e>x</span> <span style=color:#a6e22e>faster</span> <span style=color:#a6e22e>than</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>latest</span> <span style=color:#a6e22e>version</span>, <span style=color:#a6e22e>since</span> <span style=color:#a6e22e>there</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>overhead</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>reading</span> <span style=color:#a6e22e>each</span> <span style=color:#a6e22e>batch</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>navigating</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>columns</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>operate</span>. <span style=color:#a6e22e>For</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>purposes</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>post</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>stop</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>optimization</span> <span style=color:#a6e22e>efforts</span> <span style=color:#a6e22e>here</span>, <span style=color:#a6e22e>but</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>always</span> <span style=color:#a6e22e>looking</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>ways</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>make</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>real</span> <span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>engine</span> <span style=color:#a6e22e>faster</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>##</span> <span style=color:#a6e22e>Conclusion</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>By</span> <span style=color:#a6e22e>analyzing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>profiles</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>toy</span> <span style=color:#a6e22e>execution</span> <span style=color:#a6e22e>engine</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>employing</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>ideas</span> <span style=color:#a6e22e>proposed</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>MonetDB</span><span style=color:#f92672>/</span><span style=color:#a6e22e>x100</span> <span style=color:#a6e22e>paper</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>were</span> <span style=color:#a6e22e>able</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>identify</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>problems</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>implement</span> <span style=color:#a6e22e>solutions</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>improved</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>multiplying</span> <span style=color:#ae81ff>65</span>,<span style=color:#ae81ff>536</span> <span style=color:#a6e22e>rows</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>factor</span> <span style=color:#a6e22e>of</span> <span style=color:#ae81ff>20</span><span style=color:#a6e22e>x</span>. <span style=color:#a6e22e>We</span> <span style=color:#a6e22e>also</span> <span style=color:#a6e22e>used</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>generation</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>write</span> <span style=color:#a6e22e>templated</span> <span style=color:#a6e22e>code</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>then</span> <span style=color:#a6e22e>generated</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>specific</span> <span style=color:#a6e22e>implementations</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>each</span> <span style=color:#a6e22e>concrete</span> <span style=color:#66d9ef>type</span>. 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>In</span> <span style=color:#a6e22e>CockroachDB</span>, <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>incorporated</span> <span style=color:#a6e22e>all</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>changes</span> <span style=color:#a6e22e>presented</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>blog</span> <span style=color:#a6e22e>post</span> <span style=color:#a6e22e>into</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>execution</span> <span style=color:#a6e22e>engine</span>. <span style=color:#a6e22e>This</span> <span style=color:#a6e22e>resulted</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>improving</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>CPU</span> <span style=color:#a6e22e>time</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>own</span> <span style=color:#a6e22e>microbenchmarks</span> <span style=color:#a6e22e>by</span> <span style=color:#a6e22e>up</span> <span style=color:#a6e22e>to</span> <span style=color:#ae81ff>70</span><span style=color:#a6e22e>x</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>end</span><span style=color:#f92672>-</span><span style=color:#a6e22e>to</span><span style=color:#f92672>-</span><span style=color:#a6e22e>end</span> <span style=color:#a6e22e>latency</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>some</span> <span style=color:#a6e22e>queries</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>industry</span><span style=color:#f92672>-</span><span style=color:#a6e22e>standard</span> [<span style=color:#a6e22e>TPC</span><span style=color:#f92672>-</span><span style=color:#a6e22e>H</span> <span style=color:#a6e22e>benchmark</span>](<span style=color:#a6e22e>http</span>:<span style=color:#75715e>//www.tpc.org/tpch/) by as much as 4x. The end-to-end latency improvement we achieved is a lot smaller than the improvement achieved in our toy example, but note that we only focused on improving the in-memory execution of a query in this blog post. When running TPC-H queries on CockroachDB, data needs to be read from disk in its original row-oriented format before processing, which will account for the lion’s share of the query’s execution latency. Nevertheless, this is a great improvement.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>In</span> <span style=color:#a6e22e>CockroachDB</span> <span style=color:#ae81ff>19.2</span>, <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>able</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>enjoy</span> <span style=color:#a6e22e>these</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>benefits</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>common</span> <span style=color:#a6e22e>scan</span>, <span style=color:#a6e22e>join</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>aggregation</span> <span style=color:#a6e22e>queries</span>. <span style=color:#a6e22e>Here</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>s</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>demonstration</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>original</span> <span style=color:#a6e22e>sample</span> <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>from</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>blog</span> <span style=color:#a6e22e>post</span>, <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>runs</span> <span style=color:#a6e22e>nearly</span> <span style=color:#ae81ff>2</span> <span style=color:#a6e22e>times</span> <span style=color:#a6e22e>as</span> <span style=color:#a6e22e>fast</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>our</span> <span style=color:#a6e22e>new</span> <span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>engine</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`oot@127.0.0.1:64128/defaultdb&gt; CREATE TABLE inventory (id INT PRIMARY KEY, price FLOAT);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE TABLE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Time: 2.78ms
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>root@127.0.0.1:64128/defaultdb&gt; INSERT INTO inventory SELECT id, random()*10 FROM generate_series(1,10000000) g(id);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>INSERT 100000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Time: 521.757ms
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>root@127.0.0.1:64128/defaultdb&gt; EXPLAIN SELECT count(*) FROM inventory WHERE price * 0.8 &gt; 3;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>       tree      |    field    |     description
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+----------------+-------------+---------------------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 | distributed | true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 | vectorized  | true
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  group          |             |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   │             | aggregate 0 | count_rows()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   │             | scalar      |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   └── render    |             |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        └── scan |             |
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 | table       | inventory@primary
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 | spans       | ALL
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 | filter      | (price * 0.8) &gt; 3.0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(10 rows)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Time: 3.076ms`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>The</span> <span style=color:#e6db74>`EXPLAIN`</span> <span style=color:#a6e22e>plan</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>shows</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>the</span> <span style=color:#e6db74>`vectorized`</span> <span style=color:#a6e22e>field</span> <span style=color:#a6e22e>is</span> <span style=color:#e6db74>`true`</span>, <span style=color:#a6e22e>which</span> <span style=color:#a6e22e>means</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>will</span> <span style=color:#a6e22e>be</span> <span style=color:#a6e22e>run</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>engine</span> <span style=color:#a6e22e>by</span> <span style=color:#66d9ef>default</span>. <span style=color:#a6e22e>And</span>, <span style=color:#a6e22e>sure</span> <span style=color:#a6e22e>enough</span>, <span style=color:#a6e22e>running</span> <span style=color:#a6e22e>this</span> <span style=color:#a6e22e>query</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>engine</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>off</span> <span style=color:#a6e22e>shows</span> <span style=color:#a6e22e>a</span> <span style=color:#a6e22e>modest</span> <span style=color:#a6e22e>performance</span> <span style=color:#a6e22e>difference</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>**</span><span style=color:#e6db74>`root@127.0.0.1:64128/defaultdb&gt; SELECT count(*) FROM inventory WHERE price * 0.8 &gt; 3;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   count
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+---------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  6252335
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(1 row)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Time: 3.587261s
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>root@127.0.0.1:64128/defaultdb&gt; set vectorize=off;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SET
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Time: 283µs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>root@127.0.0.1:64128/defaultdb&gt; SELECT count(*) FROM inventory WHERE price * 0.8 &gt; 3;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   count
</span></span></span><span style=display:flex><span><span style=color:#e6db74>+---------+
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  6252335
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(1 row)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Time: 5.847703s`</span><span style=color:#f92672>**</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>In</span> <span style=color:#a6e22e>CockroachDB</span> <span style=color:#ae81ff>19.2</span>, <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>new</span> <span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>engine</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>automatically</span> <span style=color:#a6e22e>enabled</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>supported</span> <span style=color:#a6e22e>queries</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>likely</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>read</span> <span style=color:#a6e22e>more</span> <span style=color:#a6e22e>rows</span> <span style=color:#a6e22e>than</span> <span style=color:#a6e22e>the</span> <span style=color:#e6db74>`vectorize_row_count_threshold`</span> <span style=color:#a6e22e>setting</span> (<span style=color:#a6e22e>which</span> <span style=color:#a6e22e>defaults</span> <span style=color:#a6e22e>to</span> <span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>024</span>). <span style=color:#a6e22e>Queries</span> <span style=color:#a6e22e>with</span> <span style=color:#a6e22e>buffering</span> <span style=color:#a6e22e>operators</span> <span style=color:#a6e22e>that</span> <span style=color:#a6e22e>could</span> <span style=color:#a6e22e>potentially</span> <span style=color:#a6e22e>use</span> <span style=color:#a6e22e>an</span> <span style=color:#a6e22e>unbounded</span> <span style=color:#a6e22e>amount</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>memory</span> (<span style=color:#a6e22e>like</span> <span style=color:#a6e22e>global</span> <span style=color:#a6e22e>sorts</span>, <span style=color:#a6e22e>hash</span> <span style=color:#a6e22e>joins</span>, <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>unordered</span> <span style=color:#a6e22e>aggregations</span>) <span style=color:#a6e22e>are</span> <span style=color:#a6e22e>implemented</span> <span style=color:#a6e22e>but</span> <span style=color:#a6e22e>not</span> <span style=color:#a6e22e>yet</span> <span style=color:#a6e22e>enabled</span> <span style=color:#a6e22e>by</span> <span style=color:#66d9ef>default</span>. <span style=color:#a6e22e>For</span> <span style=color:#a6e22e>full</span> <span style=color:#a6e22e>details</span> <span style=color:#a6e22e>of</span> <span style=color:#a6e22e>what</span> <span style=color:#a6e22e>is</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>isn</span><span style=color:#960050;background-color:#1e0010>’</span><span style=color:#a6e22e>t</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>by</span> <span style=color:#66d9ef>default</span>, <span style=color:#a6e22e>check</span> <span style=color:#a6e22e>out</span> <span style=color:#a6e22e>the</span> [<span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>execution</span> <span style=color:#a6e22e>engine</span> <span style=color:#a6e22e>docs</span>](<span style=color:#a6e22e>https</span>:<span style=color:#75715e>//www.cockroachlabs.com/docs/stable/vectorized-execution). And to learn more about how we built more complicated vectorized operators check out our blog posts on the [vectorized hash joiner](https://www.cockroachlabs.com/blog/vectorized-hash-joiner/) and the [vectorized merge joiner](https://www.cockroachlabs.com/blog/vectorizing-the-merge-joiner-in-cockroachdb/). </span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Please</span> <span style=color:#a6e22e>try</span> <span style=color:#a6e22e>out</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>vectorized</span> <span style=color:#a6e22e>engine</span> <span style=color:#a6e22e>on</span> <span style=color:#a6e22e>your</span> <span style=color:#a6e22e>queries</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>let</span> <span style=color:#a6e22e>us</span> <span style=color:#a6e22e>know</span> <span style=color:#a6e22e>how</span> <span style=color:#a6e22e>you</span> <span style=color:#a6e22e>fare</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Thanks</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>reading</span>!
</span></span></code></pre></div></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=http://asubiotto.com/tags/databases/>databases</a></span>
<span class=tag><a href=http://asubiotto.com/tags/vectorized-execution/>vectorized-execution</a></span>
<span class=tag><a href=http://asubiotto.com/tags/performance/>performance</a></span>
<span class=tag><a href=http://asubiotto.com/tags/cockroachdb/>cockroachdb</a></span>
<span class=tag><a href=http://asubiotto.com/tags/sql/>sql</a></span></p></div></main></div><footer class=footer></footer></div><script type=text/javascript src=/bundle.min.ad54ad97364f77ede35def9096b162bb1f0b3973aa50b080f5e82fa147f6882e2a7200d7535adbf9b51bebf939f1c1ca9bbe6be87530092aca720eac4a226fda.js integrity="sha512-rVStlzZPd+3jXe+QlrFiux8LOXOqULCA9egvoUf2iC4qcgDXU1rb+bUb6/k58cHKm75r6HUwCSrKcg6sSiJv2g=="></script></body></html>